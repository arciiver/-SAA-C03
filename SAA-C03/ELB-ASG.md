# ALB

Application lb is layer 7 (HTTP)

## Application Load Balancer (v2) (Supports http,htpps and websocket)

- **Routing tables to different target groups:**
  - Routing based on path in URL (example.com/users & example.com/posts).
  - Routing based on hostname in URL (one.example.com & other.example.com).
  - Routing based on Query String, Headers (example.com/users?id=123&order=false).

- ALB are a great fit for microservices & container-based applications (example: Docker & Amazon ECS).
- Has a port mapping feature to redirect to a dynamic port in ECS.
- In comparison, we'd need multiple Classic Load Balancers per application.


### ALB TARGET GROUPS:
- EC2 Instances
- ECS Tasks
- Lambda functions
- IP Addresses - Private IPs
- Health Checks support the HTTP and HTTPS protocol.


## Network Load Balancer (v2)

- Network load balancers (Layer 4) allow to:
  - **Forward TCP & UDP traffic** to your instances.
  - Handle **millions of requests per second**.
  - **Less latency** ~100 ms (vs 400 ms for ALB).

- NLB has **one static IP per AZ**, and supports assigning Elastic IP (helpful for whitelisting specific IP).

- NLB are used for **extreme performance**, TCP or UDP traffic.


### NLP TARGET GROUPS

- EC2 instances
- IP addresses - must be private
- Application Load Balancer
- Health Checks support the TCP, HTTP and HTTPS protocol.


### Gateway Load Balancer

- Deploy, scale, and manage a fleet of 3rd party network virtual appliances in AWS.
- **Example:** Firewalls, Intrusion Detection and Prevention Systems, Deep Packet Inspection Systems, payload manipulation, etc.

- Operates at **Layer 3 (Network Layer)** – IP Packets.

- Combines the following functions:
  - **Transparent Network Gateway** – single entry/exit for all traffic.
  - **Load Balancer** – distributes traffic to your virtual appliances.

- Uses the **GENEVE protocol** on port **6081**.



## Sticky Sessions (Session Affinity)

- It is possible to implement stickiness so that the same client is always redirected to the same instance behind a load balancer.
- This works for:
  - Classic Load Balancer
  - Application Load Balancer
  - Network Load Balancer
- The "cookie" used for stickiness has an expiration date you control.
  
### Use Case:
- Make sure the user doesn’t lose their session data.

- **Note:** Enabling stickiness may bring an imbalance to the load over the backend EC2 instances.



## Sticky Sessions – Cookie Names

### Application-based Cookies
- **Custom cookie**
  - Generated by the target.
  - Can include any custom attributes required by the application.
  - Cookie name must be specified individually for each target group.
  - **Don’t use** AWSALB, AWSALBAPP, or AWSALBTG (reserved for use by the ELB).

- **Application cookie**
  - Generated by the load balancer.
  - Cookie name is **AWSALBAPP**.

### Duration-based Cookies
- Cookie generated by the load balancer.
- Cookie name is **AWSALB** for ALB, **AWSELB** for CLB.



## Cross-Zone Load Balancing

Den räknar ut hur många totala serverar finns i alla AZ och delar trafiken jämt över över servere

### Application Load Balancer
- Enabled by default (can be disabled at the Target Group level).
- No charges for inter-AZ data.

### Network Load Balancer & Gateway Load Balancer
- Disabled by default.
- You pay charges ($) for inter-AZ data if enabled.



## Connection Draining


### Feature Naming:
- **Connection Draining** – for CLB (Classic Load Balancer).
- **Deregistration Delay** – for ALB (Application Load Balancer) & NLB (Network Load Balancer).

### Key Details:
- Time to complete "in-flight requests" while the instance is de-registering or unhealthy.
- Stops sending new requests to the EC2 instance which is de-registering.
- Time can be set between **1 to 3600 seconds** (default: 300 seconds).
- Can be disabled by setting the value to **0**.
- Set to a low value if your requests are short.


# ASG

You can deploy it eigther with a loadbalancer or without fronteded

## Instance Maintenance Policy

Control your Auto Scaling group's availability during instance replacement events. This includes health checks, instance refreshes, maximum instance lifetime features, and events that happen automatically to keep your group balanced, called rebalancing events.

### Choose a replacement behavior depending on your availability requirements:

- **Mixed behavior:**
  - **No policy:**  
    For rebalancing events, new instances will launch before terminating others. For all other events, instances terminate and launch at the same time.

- **Prioritize availability:**
  - **Launch before terminating:**  
    Launch new instances and wait for them to be ready before terminating others. This allows you to go above your desired capacity by a given percentage and may temporarily increase costs.

- **Control costs:**
  - **Terminate and launch:**  
    Terminate and launch instances at the same time. This allows you to go below your desired capacity by a given percentage and may temporarily reduce availability.

- **Flexible:**
  - **Custom behavior:**  
    Set custom values for the minimum and maximum amount of available capacity. This gives you greater flexibility in setting how far below and over your desired capacity EC2 Auto Scaling goes when replacing instances.

### Auto Scaling Groups – Scaling Policies

### Dynamic Scaling
- **Target Tracking Scaling**
  - Simple to set up.
  - Example: I want the average ASG CPU to stay at around 40%.
  - ** METRIC TYPE:
    - Ave. cpu 
    - Ave. network in
    - Ave. network out
    - Application lb request count per target
    
- **Simple / Step Scaling**
  - When a CloudWatch alarm is triggered (example: CPU > 70%), then add 2 units.
  - When a CloudWatch alarm is triggered (example: CPU < 30%), then remove 1 unit.

### Scheduled Scaling
- Anticipate scaling based on known usage patterns.
- Example: Set the minimum capacity to 10 at 5 pm on Fridays.

### Predictive scaling: continuously forecast load and schedule scaling ahead



**PS** ## Good job!

- Network Load Balancer has one static IP address per AZ and you can attach an Elastic IP address to it.
- Application Load Balancers and Classic Load Balancers have a static DNS name.
- Server Name Indication (SNI) allows you to expose multiple HTTPS applications each with its own SSL certificate on the same listener